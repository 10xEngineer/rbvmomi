#!/usr/bin/env ruby
require 'rbvmomi'
include RbVmomi

fail "must set RBVMOMI_URI" unless ENV['RBVMOMI_URI']

soap = Soap.new URI.parse(ENV['RBVMOMI_URI'])
soap.debug = false
$profile = false

si = soap.serviceInstance
sm = si.RetrieveServiceContent!.sessionManager
sm.Login! :userName => 'root', :password => ''

rootFolder = si.RetrieveServiceContent!.rootFolder

dc = rootFolder.childEntity.first
vmFolder = dc.vmFolder
vms = vmFolder.childEntity

vms.each do |vm|
   puts "#{vm.value} #{vm.config.name} #{vm.runtime.powerState}"
end
